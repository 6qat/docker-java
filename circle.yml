machine:
  environment:
    IMAGE_NAME: java
    IMAGE_TAGS_JDK: "experimental-jdk jdk-9-ea"
    IMAGE_TAGS_JRE: "experimental-jre jre-9-ea"
    IMAGE_OWNER: jeanblanchard
    # HUB_USERNAME, HUB_PASSWORD and HUB_EMAIL should be configured from the CircleCI project settings
  services:
    - docker

checkout:
  post:
    - git submodule sync
    - git submodule update --init

dependencies:
  override:
    - docker info
    - build/build.sh --local-name=java-jdk --image-name=${IMAGE_NAME} --image-owner=${IMAGE_OWNER} --image-tags="${IMAGE_TAGS_JDK}" --dir=jdk
    - build/build.sh --local-name=java-jre --image-name=${IMAGE_NAME} --image-owner=${IMAGE_OWNER} --image-tags="${IMAGE_TAGS_JRE}" --dir=jre

test:
  override:
    - ./test.sh --image-name=java-jdk
    - ./test.sh --image-name=java-jre

deployment:
  hub:
    branch: java9
    commands:
      - build/publish.sh --local-name=java-jdk --image-name=${IMAGE_NAME} --image-owner=${IMAGE_OWNER} --image-tags="${IMAGE_TAGS_JDK}"
      - build/publish.sh --local-name=java-jre --image-name=${IMAGE_NAME} --image-owner=${IMAGE_OWNER} --image-tags="${IMAGE_TAGS_JRE}"
